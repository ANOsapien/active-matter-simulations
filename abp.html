<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Active Brownian Particles </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    body { background:#222; color:white; font-family:Arial; text-align:center; }
    canvas { border:1px solid #444; margin-top:10px; }
    #controls { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:12px; }
    label { font-size:13px; }
    button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <h2>Active Brownian Particles (ABP) </h2>

  <div id="controls">
    <label>Speed <input id="speedSlider" type="range" min="0.01" max="6" step="0.01" value="2"></label>
    <label>Noise (rotational) <input id="noiseSlider" type="range" min="0" max="1" step="0.01" value="0.12"></label>
    <label>Particles <input id="countSlider" type="range" min="10" max="800" step="10" value="200"></label>
    <label>Arrow Size <input id="sizeSlider" type="range" min="3" max="20" step="1" value="8"></label>
    <label>Trail Length <input id="trailSlider" type="range" min="0" max="300" step="1" value="0"></label>
    <button id="startBtn">Start</button>
  </div>

<script>
let particles = [];
let N = 200;
let speed = 2;
let noiseStrength = 0.12;
let arrowLen = 8;
let trailLength = 0;
const L = 800;
let running = false;

class Particle {
  constructor() {
    this.x = random(L);
    this.y = random(L);
    this.angle = random(TWO_PI);
    this.history = [];
  }
  update() {
    const prevX = this.x, prevY = this.y;
    // rotational diffusion: gaussian noise scaled by noiseStrength
    this.angle += randomGaussian() * noiseStrength;
    // move
    this.x += speed * cos(this.angle);
    this.y += speed * sin(this.angle);

    // if large jump (wrap-around) -> break trail
    if (abs(this.x - prevX) > L/2 || abs(this.y - prevY) > L/2) {
      this.history = [];
    }

    // periodic wrap
    if (this.x < 0) this.x += L;
    if (this.y < 0) this.y += L;
    if (this.x >= L) this.x -= L;
    if (this.y >= L) this.y -= L;

    // store trail
    if (trailLength > 0) {
      this.history.push({x: this.x, y: this.y});
      if (this.history.length > trailLength) this.history.shift();
    }
  }
  display() {
    // draw trail
    if (trailLength > 0 && this.history.length > 1) {
      noFill();
      stroke(255, 150, 150, 80);
      beginShape();
      for (let p of this.history) vertex(p.x, p.y);
      endShape();
    }
    // draw quiver
    push();
    translate(this.x, this.y);
    rotate(this.angle);
    stroke(255, 100, 100);
    strokeWeight(2);
    line(0,0, arrowLen, 0);
    line(arrowLen,0, arrowLen-5, 3);
    line(arrowLen,0, arrowLen-5, -3);
    pop();
  }
}

function setup() {
  createCanvas(L, L);
  initParticles();

  select('#speedSlider').input(e => speed = parseFloat(e.target.value));
  select('#noiseSlider').input(e => noiseStrength = parseFloat(e.target.value));
  select('#countSlider').input(e => { N = parseInt(e.target.value); initParticles(); });
  select('#sizeSlider').input(e => arrowLen = parseInt(e.target.value));
  select('#trailSlider').input(e => trailLength = parseInt(e.target.value));
  select('#startBtn').mousePressed(() => {
    running = !running;
    const b = select('#startBtn');
    b.html(running ? 'Stop' : 'Start');
    b.style('background', running ? '#c0392b' : '#27ae60');
  });
}

function initParticles() {
  particles = [];
  for (let i = 0; i < N; i++) particles.push(new Particle());
}

function draw() {
  background(34);
  if (running) {
    for (let p of particles) { p.update(); }
  }
  for (let p of particles) p.display();
}
</script>
</body>
</html>
