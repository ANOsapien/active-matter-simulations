<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Active Brownian Particles - Quiver</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
      body { text-align: center; font-family: sans-serif; }
      canvas { border: 1px solid black; margin-top: 10px; }
      #controls { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
      label { font-size: 14px; }
    </style>
  </head>
  <body>
    <h2>Active Brownian Particles (ABP) with Quivers</h2>
    <div id="controls">
      <label>Speed <input type="range" id="speedSlider" min="0.1" max="10" step="0.1" value="2"></label>
      <label>Noise Strength <input type="range" id="noiseSlider" min="0" max="1" step="0.01" value="0.1"></label>
      <label>Particles <input type="range" id="countSlider" min="10" max="500" step="10" value="100"></label>
      <label>Particle Size <input type="range" id="sizeSlider" min="2" max="15" step="1" value="6"></label>
      <label>Trail Length <input type="range" id="trailSlider" min="0" max="200" step="10" value="0"></label>
      <button id="pauseBtn">Pause</button>
    </div>

    <script>
      let particles = [];
      let numParticles = 100;

      let speed = 2;
      let noiseStrength = 0.1;
      let particleSize = 6;
      let trailLength = 0;
      let paused = false;

      class Particle {
        constructor() {
          this.x = random(width);
          this.y = random(height);
          this.angle = random(TWO_PI);
          this.history = [];
        }

        update() {
          // Gradual angular diffusion
          this.angle += randomGaussian(0, noiseStrength);

          // Update position
          this.x += speed * cos(this.angle);
          this.y += speed * sin(this.angle);

          // Wrap boundaries
          if (this.x < 0) this.x += width;
          if (this.y < 0) this.y += height;
          if (this.x > width) this.x -= width;
          if (this.y > height) this.y -= height;

          // Trail
          if (trailLength > 0) {
            this.history.push({ x: this.x, y: this.y });
            if (this.history.length > trailLength) {
              this.history.shift();
            }
          }
        }

        display() {
          // Draw trail
          if (trailLength > 0) {
            noFill();
            stroke(0, 100);
            beginShape();
            for (let pos of this.history) {
              vertex(pos.x, pos.y);
            }
            endShape();
          }

          // Draw quiver
          stroke(255, 100, 100);
          strokeWeight(2);
          push();
          translate(this.x, this.y);
          rotate(this.angle);
          line(0, 0, particleSize, 0);
          line(particleSize, 0, particleSize - 4, 2);
          line(particleSize, 0, particleSize - 4, -2);
          pop();
        }
      }

      function setup() {
        createCanvas(800, 800);
        for (let i = 0; i < numParticles; i++) {
          particles.push(new Particle());
        }

        // Sliders
        document.getElementById('speedSlider').addEventListener('input', e => speed = parseFloat(e.target.value));
        document.getElementById('noiseSlider').addEventListener('input', e => noiseStrength = parseFloat(e.target.value));
        document.getElementById('countSlider').addEventListener('input', e => {
          numParticles = parseInt(e.target.value);
          resetParticles();
        });
        document.getElementById('sizeSlider').addEventListener('input', e => particleSize = parseInt(e.target.value));
        document.getElementById('trailSlider').addEventListener('input', e => trailLength = parseInt(e.target.value));

        // Pause button
        document.getElementById('pauseBtn').addEventListener('click', () => paused = !paused);
      }

      function resetParticles() {
        particles = [];
        for (let i = 0; i < numParticles; i++) {
          particles.push(new Particle());
        }
      }

      function draw() {
        background(255);
        if (!paused) {
          for (let p of particles) {
            p.update();
            p.display();
          }
        } else {
          for (let p of particles) {
            p.display();
          }
        }
      }
    </script>
  </body>
</html>
